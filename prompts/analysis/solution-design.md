# 方案设计 Prompt Template

用于生成和对比技术方案的 prompt 模板。

## 场景

- 为需求设计技术方案
- 对比多个技术方案
- 架构设计
- 技术选型

## Prompt 模板

### 基础模板（生成2-3个方案）

```markdown
请为以下需求设计2-3个技术方案：

## 需求描述
[需求内容]

## 约束条件
- 技术栈：[现有技术栈]
- 时间：[时间限制]
- 资源：[资源限制]
- 性能要求：[如有]

## 请提供：

### 方案1: [方案名称]
- **概述**：简短描述方案思路
- **架构**：核心组件和交互
- **技术选型**：关键技术
- **优点**：3-5个优点
- **缺点**：3-5个缺点
- **工作量估算**：低/中/高
- **主要风险**：潜在问题

### 方案2: ...

### 方案3: ...

## 方案对比表
| 维度 | 方案1 | 方案2 | 方案3 |
|------|-------|-------|-------|
| 功能完整性 | ✅/⚠️/❌ | ... | ... |
| 性能 | 评分/5 | ... | ... |
| 开发成本 | 评分/5 | ... | ... |
| 维护成本 | 评分/5 | ... | ... |
| 风险 | 低/中/高 | ... | ... |
| 推荐度 | ⭐⭐⭐⭐⭐ | ... | ... |

## 推荐方案
- **选择**：方案X
- **理由**：详细说明为什么选择这个方案
- **Trade-off**：选择了什么，放弃了什么
```

---

### 深度评估模板（针对选定方案）

```markdown
请深入评估以下技术方案：

## 方案描述
[方案详细描述]

## 评估维度

请从以下维度评估（1-5分，5=最好）：

1. **功能性**
   - 是否满足所有需求？
   - 是否有限制？
   - 是否需要额外开发？

2. **性能**
   - 响应时间预期？
   - 吞吐量预期？
   - 资源消耗（CPU/内存/IO）？

3. **可扩展性**
   - 如何应对用户增长？
   - 如何应对数据增长？
   - 水平/垂直扩展能力？

4. **可维护性**
   - 代码清晰度如何？
   - 文档需求？
   - 后续修改成本？

5. **安全性**
   - 潜在安全风险？
   - 防范措施？

6. **兼容性**
   - 与现有系统集成难度？
   - 迁移成本？

7. **成本**
   - 开发成本
   - 运维成本
   - 授权成本

8. **时间**
   - 开发周期
   - 上线时间
   - 回滚时间

## 输出格式

### 评分汇总
| 维度 | 评分 | 说明 |
|------|------|------|
| 功能性 | 4/5 | 满足核心需求，高级功能需要额外开发 |
| 性能 | 5/5 | 响应时间 < 100ms，支持1000 QPS |
... | ... | ... |

### 潜在问题
1. [问题]
   - 严重性：Critical/High/Medium/Low
   - 建议：[如何解决]

### 改进建议
1. [建议]
   - 理由：[为什么建议]

### 关键决策点
1. [决策]
   - 原因：[为什么这么做]
   - Trade-off：[放弃了什么]
```

---

### 架构设计模板

```markdown
请为以下方案设计系统架构：

## 需求
[需求描述]

## 选定方案
[方案描述]

## 请提供：

### 1. 系统架构图
```
[用ASCII或文字描述架构]
```

**核心组件：**
- [组件1]: 职责
- [组件2]: 职责

**交互流程：**
1. 用户请求 → [组件A]
2. [组件A] → [组件B]
3. ...

---

### 2. 组件详细设计

#### 组件1: [组件名称]
- **职责**：做什么
- **接口**：
  - API: [HTTP/gRPC/消息队列]
  - 请求格式
  - 响应格式
- **技术实现**：使用的技术/框架
- **依赖**：依赖的组件/服务

#### 组件2: ...

---

### 3. 数据设计

#### 数据库Schema
[表结构]

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 缓存策略
- [缓存内容]
- [缓存Key设计]
- [TTL策略]
- [缓存更新策略]

#### 数据一致性
- 强一致性 / 最终一致性
- 如何保证？

---

### 4. 技术选型说明

#### 为什么选择[技术X]而不是[技术Y]？
- [理由1]
- [理由2]

#### 替代方案
- [方案A]: 为什么不选？
- [方案B]: 为什么不选？

---

### 5. 扩展性设计

#### 水平扩展
- 如何水平扩展？
- 需要支持的无状态设计

#### 垂直扩展
- 如何优化单机性能？
- 瓶颈在哪里？

#### 读写分离
- 是否需要？
- 如何实现？

---

### 6. 容错设计

#### 故障隔离
- [组件]故障时如何处理？

#### 降级策略
- [场景]时如何降级？

#### 限流保护
- 在哪里限流？
- 限流策略？

---

### 7. 安全设计

#### 认证授权
- 如何认证？
- 如何授权？

#### 数据加密
- 传输加密
- 存储加密

#### 防护措施
- SQL注入
- XSS
- CSRF
- ...
```

---

## 实际例子

### 例子 1：搜索系统优化

**输入：**
```
需求：优化搜索功能
- 当前响应时间：5-10秒
- 目标：<1秒
- 数据量：100万商品
- 并发：500 QPS
```

**AI输出（方案对比）：**

```markdown
## 方案对比

### 方案1: SQL优化 + 索引
- **概述**：优化现有SQL查询，添加索引
- **架构**：数据库 + 应用层
- **技术**：PostgreSQL, SQL优化
- **优点**：
  - 改动最小，风险低
  - 开发快（1-2周）
  - 团队熟悉
- **缺点**：
  - 性能提升有限（可能2-3秒）
  - 复杂查询仍然慢
- **工作量**：低
- **风险**：低

### 方案2: Redis缓存 + 热数据
- **概述**：热数据缓存到Redis，冷数据查数据库
- **架构**：应用层 → Redis + DB
- **技术**：Redis, 缓存策略
- **优点**：
  - 热数据响应快（< 100ms）
  - 开发较快（2-3周）
  - 成本低
- **缺点**：
  - 缓存一致性复杂
  - 冷数据仍然慢
- **工作量**：中
- **风险**：中（缓存失效问题）

### 方案3: Elasticsearch全文搜索
- **概述**：迁移到Elasticsearch专门处理搜索
- **架构**：应用层 → ES + DB
- **技术**：Elasticsearch, 同步机制
- **优点**：
  - 性能优秀（< 500ms）
  - 功能强大（全文、聚合、拼音）
  - 可扩展性好
- **缺点**：
  - 迁移成本高（4-6周）
  - 运维复杂
  - 数据同步复杂
- **工作量**：高
- **风险**：高（数据迁移风险）

---

## 方案对比表
| 维度 | 方案1: SQL优化 | 方案2: Redis缓存 | 方案3: ES |
|------|--------------|---------------|----------|
| 功能完整性 | ⚠️ 基础搜索 | ✅ 基础+缓存 | ✅ 高级搜索 |
| 性能 | ⭐⭐ (2-3s) | ⭐⭐⭐ (<500ms) | ⭐⭐⭐⭐⭐ (<100ms) |
| 开发成本 | ⭐⭐⭐⭐⭐ (1-2w) | ⭐⭐⭐⭐ (2-3w) | ⭐⭐ (4-6w) |
| 维护成本 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| 风险 | ⭐⭐⭐⭐⭐ 低 | ⭐⭐⭐ 中 | ⭐⭐ 高 |
| 推荐度 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 推荐方案：方案3 - Elasticsearch

**理由：**
1. **性能达标** - ES专精搜索，性能优势明显
2. **功能丰富** - 支持拼音、同义词、聚合等高级功能
3. **可扩展** - 后续可以扩展到更多搜索场景
4. **团队经验** - 团队有ES经验（2个案例）

**Trade-off：**
- 选择：高性能、功能丰富、可扩展性
- 放弃：快速上线（多花2-3周）
- 接受：增加运维复杂度

**风险应对：**
- 数据迁移风险 → 灰度迁移 + 备份
- ES运维复杂 → 使用托管服务（AWS ES）
```

---

### 例子 2：架构设计（Elasticsearch）

**输入：**
```
选定方案：Elasticsearch
请设计详细架构
```

**AI输出（部分）：**

```markdown
### 1. 系统架构图

```
┌─────────────┐
│  Web App    │
└──────┬──────┘
       │ REST API
┌──────▼──────┐
│  API Server │
└──────┬──────┘
       │
       ├───▶ ┌──────────────┐
       │    │ Elasticsearch │
       │    │  (Search)    │
       │    └──────────────┘
       │
       └───▶ ┌──────────────┐
            │ PostgreSQL   │
            │  (Primary)   │
            └──────┬───────┘
                   │
                   └─▶ ┌──────────────┐
                       │ Kafka        │
                       │ (Sync Queue) │
                       └──────┬───────┘
                              │
                              ▼
                       ┌──────────────┐
                       │ Elasticsearch │
                       │  (Indexer)   │
                       └──────────────┘
```

**核心组件：**
- **API Server**: 处理搜索请求，查询ES
- **Elasticsearch**: 存储搜索索引，处理搜索
- **PostgreSQL**: 主数据库，存储商品数据
- **Kafka**: 消息队列，用于数据同步
- **Indexer**: 消费Kafka消息，同步数据到ES

**交互流程：**
1. 商品更新 → 写入PostgreSQL
2. PostgreSQL触发器 → 发送消息到Kafka
3. Indexer消费消息 → 更新ES索引
4. 用户搜索 → API Server查询ES → 返回结果

---

### 3. 数据设计

#### Elasticsearch Schema

```json
PUT /products
{
  "mappings": {
    "properties": {
      "id": {"type": "keyword"},
      "name": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "keyword": {"type": "keyword"}
        }
      },
      "description": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "price": {"type": "float"},
      "category": {"type": "keyword"},
      "tags": {"type": "keyword"},
      "created_at": {"type": "date"}
    }
  }
}
```

**分析器说明：**
- `ik_max_word`: 中文分词器，支持同义词

#### 缓存策略
- **查询缓存**：ES查询结果缓存（TTL: 5分钟）
- **应用层缓存**：热门搜索词缓存（Redis, TTL: 1小时）

#### 数据一致性
- **最终一致性**：PostgreSQL写入后5秒内同步到ES
- **如何保证**：
  - Kafka确保消息不丢失
  - Indexer幂等处理
  - 定期全量校验

---

### 6. 安全设计

#### 访问控制
- API层认证：JWT token验证
- ES访问控制：IP白名单 + Basic Auth

#### 数据加密
- 传输加密：HTTPS/TLS
- 存储加密：AWS ES加密（默认开启）

#### 防护措施
- SQL注入：不适用（ES用DSL）
- XSS：输入过滤 + 输出转义
- 限流：API层限流（1000 req/min/IP）
```

---

## 关键原则

### 1. 对比至少2个方案

不要只提供1个方案，对比才能发现优劣。

### 2. 量化评估

用数据和评分对比，而不是主观描述。

### 3. 说明Trade-off

没有完美方案，说明选择什么，放弃什么。

### 4. 风险前置

在设计阶段识别风险，提前规划应对策略。

---

## 实战技巧

### 技巧1：用表格对比

清晰的对比表能快速看到差异：

| 维度 | 方案A | 方案B |
|------|-------|-------|
| 性能 | < 100ms | < 500ms |
| 成本 | $100/月 | $50/月 |
| 风险 | 低 | 中 |

---

### 技巧2：提供实施路径

大方案分阶段：

```
Phase 1: POC验证 (1周)
- 搭建ES环境
- 迁移1000条数据测试
- 性能基准测试

Phase 2: 灰度迁移 (2周)
- 迁移10%数据
- 双写验证
- 监控数据一致性

Phase 3: 全量迁移 (1周)
- 迁移剩余数据
- 切换流量到ES
- 保留DB一周用于回滚
```

---

## 参考资料

### 相关文档
- [02-solution-design.md](../phases/02-solution-design.md) - 方案设计方法论
- [requirement-clarification.md](./requirement-clarification.md) - 需求澄清
