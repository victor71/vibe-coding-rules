# Complex Refactor Prompt Template

大型重构任务的 prompt 模板。

## 场景

- 重构整个模块
- 更改架构或设计模式
- 性能优化
- 技术债务清理

## Prompt 模板

```
重构 [模块/区域] 以达到 [目标]。

当前状态：
- [描述当前架构/结构]
- 问题：[列出具体问题]

目标状态：
- [描述期望的架构/结构]
- 预期改进：[性能、可维护性等]

要求：
1. 尽可能保持向后兼容
2. 为新结构添加全面的测试
3. 在 CHANGELOG.md 中记录任何破坏性变更
4. 根据需要更新依赖代码
5. 确保所有现有测试仍然通过

约束：
- [任何约束：性能、安全、兼容性]

分析后提供：
1. 进行更改前的建议计划
2. 风险评估
3. 对现有功能的预计影响
```

## 实际例子

### 例子：重构数据访问层

```
重构 models/db.py 中的数据库访问层以使用 ORM。

当前状态：
- 整个代码库中分散着直接的 SQL 查询
- 没有类型安全
- 难以测试
- 容易受到 SQL 注入攻击

目标状态：
- 使用 SQLAlchemy ORM
- 类型安全的模型
- 查询构建器模式
- 自动迁移

要求：
1. 保持现有 API 端点不变
2. 添加迁移脚本
3. 添加全面的单元测试
4. 更新所有直接 SQL 查询以使用 ORM
5. 性能不应下降

约束：
- 数据库 schema 更改必须向后兼容
- 不能超过当前查询性能（之后进行基准测试）
- 必须仅支持 PostgreSQL

分析后提供：
1. 包含步骤的迁移计划
2. 风险评估（可能出现什么问题）
3. 性能比较计划
4. 出现问题时的回滚策略
```

## 关键原则

1. **先分析再行动** - 要求 Claude 先给计划
2. **明确目标和约束** - 知道要去哪里，不能做什么
3. **保持兼容性** - 尽量不破坏现有功能
4. **完整测试** - 新代码必须有测试
5. **文档化变更** - CHANGELOG、注释、README

## 分阶段策略

对于特别大的重构，分成多个阶段：

```
Phase 1: Analysis and Planning
分析当前代码库并提出重构计划。

Phase 2: Core Infrastructure
在保持旧代码工作的同时构建新的 ORM 层。

Phase 3: Incremental Migration
逐个模块迁移，每一步都进行测试。

Phase 4: Cleanup
删除旧代码并完成最终工作。
```
